var dt_antrian,nomor_dipanggil,nomor_dipanggil_tanpa_kode,id_dipanggil;let isPrioritas,toast_show=!1;$(document).ready((function(){$("#sidebar_antrian").addClass("active"),dt_antrian=$("#dt_antrian").DataTable({dom:"Bfrtip",ordering:!1,searching:!1,ajax:{type:"post",url:base_url+"antrian/antrian/"+layanan,data:{layanan:layanan},dataSrc:""},columns:[{data:"id"},{data:null,sortable:!1,render:function(a,n,e,t){return berurut?kode+e.no:e.no}},{data:"status",sortable:!1},{data:"catatan"},{data:"ke"},{data:null,sortable:!1,render:function(a,n,e,t){return"Eksotis"}},{data:null,sortable:!1,render:function(a,n,e,t){let o=0;return"prioritas"==e.layanan&&(o=1),"<a href='#' onclick='panggil("+e.id+","+e.no+","+o+")' class='btn btn-primary'><i class='fas fa-phone'></i> Panggil</a>"}}],columnDefs:[{targets:[0,4],visible:!1},{targets:"_all",className:"text-center",orderable:!1}],createdRow:(a,n,e,t)=>{"prioritas"==n.layanan&&($(a).addClass("prioritas"),ada_prioritas(n.no))},responsive:!0,autoWidth:!1}),setInterval((()=>{dt_antrian.ajax.reload(null,!1)}),5e3),dt_antrian.on("draw",(function(){cek_prioritas()})),$("#btn_pengumuman").click((function(){$("#pengumumanModal").modal({backdrop:"static",keyboard:!1})})),$("#modal_pengumuman").click((function(){let a=$("#text_pengumuman").val();$.ajax({type:"POST",url:base_url+"antrian/panggil",data:{no:0,layanan:"pengumuman",pengumuman:a},dataType:"json",beforeSend:function(){$(".loader2").show()},success:function(a){1==a.success?cek_panggilan_pengumuman(a.id):($(".loader2").hide(),alert("Gagal memanggil, silahkan coba lagi"))},error:function(a){console.log(a.responseText),$(".loader2").hide(),alert("Gagal memanggil, silahkan coba lagi")}})}))}));const panggil=(a,n,e)=>{nomor_dipanggil_tanpa_kode=n,n=berurut?kode+n:n,isPrioritas=e,$.ajax({type:"post",url:base_url+"antrian/panggil",data:{no:n,layanan:loket,prioritas:e},dataType:"json",beforeSend:function(){$(".loader2").show()},success:function(e){1==e.success?(nomor_dipanggil=n,id_dipanggil=a,cek_panggilan(e.id)):($(".loader2").hide(),alert("gagal memanggil, silahkan coba lagi"))},error:function(a){console.log(a.responseText),$(".loader2").hide(),alert("gagal memanggil, silahkan coba lagi")}})},panggil_lagi=()=>{var a,n,e;a=id_dipanggil,e=isPrioritas,nomor_dipanggil_tanpa_kode=n=nomor_dipanggil_tanpa_kode,n=berurut?kode+n:n,isPrioritas=e,$.ajax({type:"post",url:base_url+"antrian/panggil",data:{no:n,layanan:loket,prioritas:e},dataType:"json",beforeSend:function(){$(".loader2").show()},success:function(e){1==e.success?(nomor_dipanggil=n,id_dipanggil=a,cek_panggilan(e.id)):($(".loader2").hide(),alert("gagal memanggil, silahkan coba lagi"))},error:function(a){console.log(a.responseText),$(".loader2").hide(),alert("gagal memanggil, silahkan coba lagi")}})},cek_panggilan=a=>{let n=!1;$.ajax({type:"post",url:base_url+"antrian/cek_panggilan",data:{id:a},dataType:"json",success:function(a){1!=a.efek&&(n=!0)},complete:function(){n?($("#modal-title").text("Nomor Antrian "+nomor_dipanggil),$("#alasanTunda").val(""),$("#modal").modal({backdrop:"static",keyboard:!1}),0==berurut?ke():$(".loader2").hide()):setTimeout((()=>{cek_panggilan(a)}),3e3)}})},cek_panggilan_pengumuman=a=>{let n=!1;$.ajax({type:"post",url:base_url+"antrian/cek_panggilan",data:{id:a},dataType:"json",success:function(a){1!=a.efek&&(n=!0)},complete:function(){n?$(".loader2").hide():setTimeout((()=>{cek_panggilan_pengumuman(a)}),3e3)}})},ke=()=>{$("#ke");const a=isNaN(loket);$.ajax({type:"post",url:base_url+"setting/data_layanan",data:{loket:a},dataType:"json",success:function(a){$("#ke").empty();for(let n=0;n<a.length;n++){let e=a[n];$("#ke").append("<option value="+e.layanan+">"+e.nama_layanan+"</option>")}},error:function(a){console.log(a.responseText)},complete:function(){$(".loader2").hide()}})},arahkan=()=>{const a=$("#ke").val(),n=$("#ke option:selected").text(),e=$("#alasanTunda").val().trim();$.ajax({type:"post",url:base_url+"antrian/ubah",data:{id:id_dipanggil,ke:a,alasan:e},dataType:"json",beforeSend:function(){$(".loader2").show()},success:function(a){1==a.success?($("#modal").modal("toggle"),toast_show=!1,dt_antrian.ajax.reload(),$("#respon").html("<div class='alert alert-success' role='alert' id='responMsg'><strong>Selamat</strong> Antrian berhasil diarahkan ke "+n+"</div>"),$("#responMsg").hide().fadeIn(200).delay(2e3).fadeOut(1e3,(function(){$(this).remove()}))):alert("maaf ada kesalahan, mohon coba kembali")},error:function(a){console.log(a.responseText)},complete:function(){$(".loader2").hide()}})},tunda=()=>{const a=$("#alasanTunda").val().trim();""!=a?$.ajax({type:"post",url:base_url+"antrian/ubah",data:{id:id_dipanggil,ke:"tunda",alasan:a},dataType:"json",beforeSend:function(){$(".loader2").show()},success:function(a){1==a.success?($("#modal").modal("toggle"),toast_show=!1,dt_antrian.ajax.reload(),$("#respon").html("<div class='alert alert-success' role='alert' id='responMsg'><strong>Selamat</strong> Antrian berhasil ditunda</div>"),$("#responMsg").hide().fadeIn(200).delay(2e3).fadeOut(1e3,(function(){$(this).remove()}))):alert("maaf ada kesalahan, mohon coba kembali")},error:function(a){console.log(a.responseText)},complete:function(){$(".loader2").hide()}}):alert("Silahkan isi alasan menunda antrian")},hapus=()=>{$.ajax({type:"post",url:base_url+"antrian/hapus",data:{id:id_dipanggil},dataType:"text",beforeSend:function(){$(".loader2").show()},success:function(a){1==a?($("#modal").modal("toggle"),toast_show=!1,dt_antrian.ajax.reload(),$("#respon").html("<div class='alert alert-success' role='alert' id='responMsg'><strong>Selamat</strong> Antrian berhasil dihapus</div>"),$("#responMsg").hide().fadeIn(200).delay(2e3).fadeOut(1e3,(function(){$(this).remove()}))):alert("maaf ada kesalahan, mohon coba kembali")},error:function(a){console.log(a.responseText)},complete:function(){$(".loader2").hide()}})},ada_prioritas=a=>{0==toast_show&&($(".toast-body").html(`Nomor antrian <span style="color: red;">${a}</span> adalah prioritas, mohon untuk segera dipanggil`),$("#toast_ku").toast("show"),toast_show=!0)},cek_prioritas=()=>{dt_antrian.rows(".prioritas").any()||$("#toast_ku").toast("hide")};